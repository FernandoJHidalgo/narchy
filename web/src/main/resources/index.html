<html>
<head>

    <title>NARchy</title>

    <style type="text/css">
        @import url("terminal.css");
        @import url("spacegraph.dark.css");
        @import url("spacegraph.css");
    </style>
    <link rel="import" href="init.html">

    <style>




        #active {
            position: fixed;
            width: 100%;
        }

        #view {
            height: 100%;
        }

        #mainButtons {
            z-index: 20000 !important;
            position: fixed;
            top: 0;
            left: 0;
        }

        .mainPopup {
            position: relative;
            top: 15px;
            left: 15px;
        }

        #mainButtons div {
            margin: 0 !important;
            z-index: 20000 !important;
        }

        #mainButtons .button {
            opacity: 0.75;
            vertical-align: top !important;
        }

        #mainButtons .button.active {
            opacity: 1.0;
        }

        .NARConsole {
            width: 100% !important;
            height: 100% !important;
        }

        #nalInput {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px;
            opacity: 0.8;
            margin: 0;
            border: 0;
        }

        #nalInput .NALEditor {
            font-size: 30px;
        }

        .ui-dialog {
            opacity: 0.8 !important;
        }

        .simone-taskbar-horizontal.simone-taskbar-stick-top .simone-taskbar-window-buttons-container {
            padding-left: 80px; /* shift over so that the main buttons dont cover the left taskbar buttons */

        }

        div.ConceptTable {
            width: 100%;
            height: 100%;
            background-color: black;
            font-family: monospace;
            font-stretch: condensed;
        }

        .ConceptRow {
           /*width: 100%;*/
            line-height: 100%;


            padding-right: 10px;
        }

    </style>


</head>
<body>


<div id="view" style="position: fixed; width: 100%; height: 100%; padding-top: 36px;"></div>


<div class="taskbar">

</div>


<div id="mainButtons">

</div>

<!--<div class="ui grid">-->

<!--<div class="four wide column">-->
<!--<div class="ui segment" style="opacity: 0.2">-->
<!--<h1>Emotion</h1>-->
<!--<div id="emotion"></div>-->
<!--</div>-->
<!--</div>-->

<!--</div>-->

<!--<div id="menu"></div>-->

<div id="narOutput">
</div>

<div id="menu" class="ui compact vertical menu" style="position: absolute">

    <div class="item" id="log">+ Log</div>
    <div class="item" id="timeline">+ Timeline</div>
    <div class="item">+ Status</div>
    <hr/>
    <div class="item">Load...</div>
    <div class="item">Save...</div>
    <hr/>
    <div class="item">CPU Limit (slider)</div>
    <div class="item">Memory Limit (slider)</div>
    <hr/>
    <div class="item">Reset</div>
    <div class="item">Shutdown</div>
</div>

</body>


<script src="narchy.js"></script>

<script>
    "use strict";

    var terminal, viewing = undefined;

    function addView(v) {
        /*
         <div class="ui dropdown icon purple button" id="rootButton">
         <i class="bomb icon"></i>
         <i class="dropdown icon"></i>
         <div class="menu">
         <div class="item">
         <i class="options icon"></i>
         <select id="rootSelect">

         </select>

         <div id="rootOptions" class="ui segment">
         options..
         <!-- updated by change in rootSelect selector -->
         </div>

         <button class="right floated primary ui button" onclick="$('#rootButton .menu').hide()">OK</button>
         </div>
         </div>
         </div>
         */

        var dropDownIcon;

        //button
        var b = $('<div class="ui icon ' + v.color + ' button"/>').append(
                '<i class="' + v.icon + ' icon"></i>',
                dropDownIcon = $('<i class="dropdown icon"></i>')
        ).attr('title', v.id);

        var ddMenu = $('<div class="mainPopup item"/>');
        ddMenu.hide().appendTo(b).append(v.menu());


        if (!v.start) {
            b.addClass('active');
        }

        v.update = function () {
            if (viewing === v) {
                b.addClass('active');

                dropDownIcon.show();

                setTimeout(v.start, 0);
            } else {

                if (v.start || v.stop) {
                    b.removeClass('active');
                    dropDownIcon.hide();
                    ddMenu.hide();
                }

                if (v.stop) {
                    if (viewing !== undefined) {
                        setTimeout(v.stop, 0);
                    }
                }
            }
        };


        function enable() {
            if (viewing !== v) {
                var prev = viewing;

                //enable drop-down
                viewing = v;

                if (prev) {
                    prev.update();
                }

                $('#view').empty();

                v.update();

                return true;
            }
            return false;
        }

        function toggle() {
            ddMenu.toggle(0);
        }

        b.click(function (e) {
            if (v.start) {
                if (viewing !== v) {
                    enable();
                } else {
                    toggle();
                }
            } else {
                toggle();
            }
        });
        b.dblclick(function () {
            if (enable())
                toggle();
        });

        v.update();

        $('#mainButtons').append(b);


        return v;
    }

    function TaskBar(target, menu) {


        // taskbar has to be created first
        var tasks = target;

        var o = {
            windowsContainment: "viewport",
            horizontalStick: "top right",
            draggable: true,
            buttons: {},
            buttonsOrder: []
//            buttons: {
//                log: {
//                    label: "Log",
//                },
//                timeline: {
//                    Label: "Timeline"
//                }
//            },
//
//            buttonsOrder: [ "log", 'timeline' ]

        };

        tasks.taskbar(o);

        /** creates a new taskbar-managed window */
        tasks.newWindow = function (title, contentBuilder, onClose, onResized) {
            return contentBuilder().window({
                taskbar: this,
                title: title,
                close: onClose,
                resizeStop: onResized
            });
        };


        //setup main menus


        _.each(menu, function (m, k) {
            var menuitem = $('#' + k);
            if (menuitem.length === 0)
                console.error('menu item not found', k);

            menuitem.click(function () {
                m.onClick(tasks);
            });
        });


        return tasks;

    }


    $(document).ready(function () {

        terminal = NARTerminal();

        //TaskDB(DB(), terminal);

        addView({
            id: 'main',
            icon: 'warning',
            color: 'orange',
            menu: function () {
                return $('#menu');
            }
        });

        addView({
            id: 'graph',
            icon: 'bomb',
            color: 'yellow',
            start: function () {
                $('#view').append(this.graph = SocketNARGraph("active"));
            },
            menu: function () {
                return 'abc';
            },
            stop: function () {
                this.graph.stop();
            }
        });
        addView({
            id: 'status',
            icon: 'options',
            color: 'green',
            start: function () {
                $('#view').append(SocketMetaWidget("emotion"));
            },
            menu: function () {
                return 'abc';
            },
            stop: function () {

            }
        });
        addView({
            id: 'top',
            icon: 'options',
            color: 'blue',
            start: function () {
                $('#view').append(TopTable("active"));
            },
            menu: function () {
                return 'abc';
            },
            stop: function () {

            }
        });


        /*
         <option>Graph</option>
         <option>Tasks</option>
         <option>Terminal</option>
         <option>Status/InterNARs</option>
         <option>News</option>
         <option>Map</option>
         <option>Social</option>
         <option>Web Browser</option>
         */

        var taskbar = TaskBar($(".taskbar"), {
            'log': {
                onClick: function (taskbar) {
                    var c = NARConsole(terminal);

                    taskbar.newWindow("Log",
                            function () {
                                return c;
                            },
                            function (event) {
                                console.log('close');
                            },
                            function (event, ui) {
                                c.editor.resize(true); //ace editor needs resized manually when its container has
                            }
                    );
                }
            },
            'timeline': {
                onClick: function (taskbar) {
                    var g = SocketNARGraph("active");

                    taskbar.newWindow("Timeline",
                            function () {
                                return c;
                            },
                            function (event) {
                                console.log('close');
                            },
                            function (event, ui) {
                                c.editor.resize(true); //ace editor needs resized manually when its container has
                            }
                    );
                }
            }
        });


        /** input line */
        $("body").append(NARInputter(terminal).attr('id', 'nalInput'));




    });

</script>
</html>